<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/index.css">
    <link rel="stylesheet" href="/static/pdf-organize.css">
    <title>FormatX | Re-Organize PDF</title>
    <link rel="icon" href="/static/assets/logo.png">
</head>

<body>
    <header>
        <div class="logo">FormatX</div>
        <nav>
            <a href="./">Home</a>
            <a href="/pdf-merge">Merge PDF</a>
            <a href="/pdf-organize" class="active">Re-Organize PDF</a>
            <a href="/pdf-split">Split PDF</a>
            <a href="/pdf-to-docx">Convert PDF</a>
        </nav>
    </header>
    <main>
        <section class="intro">
            <h1>Re-Organize PDFs</h1>
            <p>
                Break apart your PDF into individual pages for reordering or deletion. Follow these steps:
            </p>
            <ul>
                <li><strong>Upload Your File:</strong> Click "Upload PDF" to upload a single PDF file.</li>
                <li><strong>Reorder or Delete:</strong> Drag pages to reorder or click "X" to delete a page.</li>
                <li><strong>Save Changes:</strong> Click "Save PDF" to download the reorganized file.</li>
            </ul>
        </section>
    </main>

    <div class="file-upload-section">
        <form id="organizeForm" action="/pdf-organize" method="POST" enctype="multipart/form-data">
            <div class="button-container">
                <label for="file-input" class="custom-file-upload">Upload PDF</label>
                <button type="button" class="reset-file" onclick="window.location.reload()">Reset</button>
            </div>
            <input type="file" id="file-input" name="file" accept="application/pdf">
            <p id="file-limit-message" style="color: red; display: none;">Maximum of 20 files allowed*</p>
            <center>
                <div id="page-list" class="file-list">
                    <p id="default-text" class="default-text-class">No file uploaded yet. Use the upload button above.
                    </p>
                </div>
            </center>
            <center><button type="submit" class="organize-button" disabled>Save PDF</button></center>
        </form>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        const fileInput = document.getElementById('file-input');
        const pageListContainer = document.getElementById('page-list');
        const defaultText = document.getElementById('default-text');
        const organizeButton = document.querySelector('.organize-button');

        let pagesList = [];

        fileInput.addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            pageListContainer.innerHTML = '';  // Clear the existing previews or page items
            pagesList = [];  // Clear the pages list array

            const file = event.target.files[0];
            if (!file) return;

            const existingDefaultText = document.getElementById('default-text');
            if (existingDefaultText) {
                existingDefaultText.remove();
            }

            renderPDFPages(file);
        }

        function renderPDFPages(file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const pdfData = new Uint8Array(e.target.result);
                pdfjsLib.getDocument(pdfData).promise.then(pdf => {
                    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                        pdf.getPage(pageNum).then(page => {
                            const pageItem = document.createElement('div');
                            pageItem.classList.add('page-item');
                            pageItem.dataset.pageNum = pageNum;

                            const previewContainer = document.createElement('div');
                            previewContainer.classList.add('pdf-preview-container');
                            pageItem.appendChild(previewContainer);

                            const removeButton = document.createElement('button');
                            removeButton.classList.add('remove-page');
                            removeButton.textContent = 'X';
                            removeButton.title = 'Remove this page';
                            removeButton.addEventListener('click', () => {
                                pagesList = pagesList.filter(p => p !== pageNum);
                                pageItem.remove();
                                if (pagesList.length === 0) {
                                    window.location.reload();
                                }
                                organizeButton.disabled = pagesList.length === 0;
                            });
                            pageItem.appendChild(removeButton);

                            renderPDFPreview(page, previewContainer);

                            pageListContainer.appendChild(pageItem);
                            pagesList.push(pageNum);

                            enableDragAndDrop();
                            organizeButton.disabled = false;
                        });
                    }
                });
            };
            reader.readAsArrayBuffer(file);
        }

        function renderPDFPreview(page, container) {
            const scale = 1.5;
            const viewport = page.getViewport({ scale });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            canvas.height = viewport.height;
            canvas.width = viewport.width;
            page.render({ canvasContext: context, viewport }).promise.then(() => {
                container.appendChild(canvas);
            });
        }

        function enableDragAndDrop() {
            new Sortable(pageListContainer, {
                animation: 150,
                onEnd: () => {
                    pagesList = Array.from(pageListContainer.children).map(item => parseInt(item.dataset.pageNum));
                }
            });
        }

        document.getElementById('organizeForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const formData = new FormData();
            formData.append('file', fileInput.files[0]); // Add the file
            formData.append('pages', JSON.stringify(pagesList));

            fetch('/pdf-organize', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.organized_file_url) {
                        const downloadLink = document.createElement('a');
                        downloadLink.href = data.organized_file_url;
                        downloadLink.download = 'organized_output.pdf';
                        downloadLink.click();
                        alert('PDF reorganized successfully!');
                    } else if (data.error) {
                        alert(data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error reorganizing PDF');
                });
        });

    </script>
</body>

</html>