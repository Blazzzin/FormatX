<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/index.css">
    <link rel="stylesheet" href="/static/pdf-merge.css">
    <title>Merge PDFs</title>
</head>

<body>
    <header>
        <div class="logo">FormatX</div>
        <nav>
            <a href="./">Home</a>
            <a href="/pdf-merge" class="active">Merge PDF</a>
            <a href="/pdf-split">Split PDF</a>
            <a href="/pdf-organize">Re-Organize PDF</a>
            <a href="/pdf-to-docx">Convert PDF</a>
            <!-- <a href="/image">Convert Images</a> -->
        </nav>
    </header>
    <main>
        <section class="intro">
            <h1>Merge Multiple PDFs Into One</h1>
            <p>
                With our PDF Merge tool, combining multiple PDF files into a single document has never been easier.
                Simply follow these steps:
            </p>
            <ul>
                <li><strong>Upload Your Files:</strong> Click the "Upload Files" button to select multiple PDF files
                    from your device. You can select a maximum of 20 files from your device.</li>
                <li><strong>Arrange the Files:</strong> Once the files are uploaded, you can easily reorder them by
                    dragging and dropping. Arrange them in the sequence you want the final document to appear.</li>
                <li><strong>Preview the Files:</strong> Each file has a little preview of the first page so that you
                    know you are confidently rearranging the correct file in the correct order.</li>
                <li><strong>Merge the PDFs:</strong> When you're happy with the order and the previews, simply click the
                    "Merge PDFs" button to combine all selected files into a single PDF.</li>
                <li><strong>Download the Final Document:</strong> Once the merge is complete, the final newly merged PDF
                    will be downloaded onto your device!</li>
            </ul>
            <p>
                This tool is perfect for combining contracts, reports, or any collection of PDF documents into one
                convenient file. Whether youâ€™re managing work documents or personal files, our simple and intuitive
                interface will help you get the job done in just a few clicks!
            </p>
        </section>
    </main>

    <div class="file-upload-section">
        <form id="mergeForm" action="/pdf-merge" method="POST" enctype="multipart/form-data">
            <div class="button-container">
                <label for="file-input" class="custom-file-upload">Upload Files</label>
                <button type="button" class="clear-files" onclick="window.location.reload()">Clear All Files</button>
            </div>
            <input type="file" id="file-input" name="files[]" accept="application/pdf" multiple>
            <p id="file-limit-message" style="color: red; display: none;">Maximum of 20 files allowed*</p>
            <center>
                <div id="file-list" class="file-list">
                    <p id="default-text" class="default-text-class">No files uploaded yet. Use the upload button above.
                    </p>
                </div>
            </center>
            <center><button type="submit" class="merge-button" disabled>Merge PDFs</button></center>
        </form>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        const MAX_FILES = 20;
        let filesList = [];

        const fileInput = document.getElementById('file-input');
        const fileListContainer = document.getElementById('file-list');
        const defaultText = document.getElementById('default-text');
        const fileLimitMessage = document.getElementById('file-limit-message');
        const mergeButton = document.querySelector('.merge-button');

        fileInput.addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);

            if (filesList.length + files.length > MAX_FILES) {
                fileLimitMessage.style.display = 'block';
                return;
            }

            fileLimitMessage.style.display = 'none';

            const existingDefaultText = document.getElementById('default-text');
            if (existingDefaultText) {
                existingDefaultText.remove();
            }

            files.forEach(file => {
                if (!filesList.some(existingFile => existingFile.name === file.name)) {
                    filesList.push(file);

                    const fileItem = document.createElement('div');
                    fileItem.classList.add('file-item');
                    fileItem.textContent = file.name;

                    // Add "X" button to remove the file
                    const removeButton = document.createElement('button');
                    removeButton.classList.add('remove-file');
                    removeButton.textContent = 'X';
                    removeButton.title = 'Remove this file';

                    // Remove the file when the "X" button is clicked
                    removeButton.addEventListener('click', () => {
                        filesList = filesList.filter(f => f.name !== file.name);
                        fileItem.remove();
                        if (filesList.length === 0) {
                            const placeholderText = document.createElement('p');
                            placeholderText.id = 'default-text';
                            placeholderText.className = 'default-text-class';
                            placeholderText.textContent = 'No files uploaded yet. Use the upload button above.';
                            fileListContainer.appendChild(placeholderText);
                        }
                        mergeButton.disabled = filesList.length === 0;
                    });

                    fileItem.appendChild(removeButton);

                    const previewContainer = document.createElement('div');
                    previewContainer.classList.add('pdf-preview-container');
                    fileItem.appendChild(previewContainer);

                    fileItem.file = file;
                    fileListContainer.appendChild(fileItem);

                    renderPDFPreview(file, previewContainer);
                }
            });

            enableDragAndDrop();
            mergeButton.disabled = filesList.length === 0;
        }

        function renderPDFPreview(file, container) {
            if (file.type !== 'application/pdf') return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const pdfData = new Uint8Array(e.target.result);
                pdfjsLib.getDocument(pdfData).promise.then(pdf => {
                    pdf.getPage(1).then(page => {
                        const scale = 1.5;
                        const viewport = page.getViewport({ scale });
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');

                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        page.render({ canvasContext: context, viewport }).promise.then(() => {
                            container.appendChild(canvas);
                        });
                    });
                });
            };
            reader.readAsArrayBuffer(file);
        }

        function enableDragAndDrop() {
            new Sortable(fileListContainer, {
                animation: 150,
                onEnd: () => {
                    filesList = Array.from(fileListContainer.children).map(item => item.file);
                }
            });
        }

        document.getElementById('mergeForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const formData = new FormData();
            filesList.forEach(file => formData.append('files[]', file));

            fetch('/pdf-merge', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.merged_file_url) {
                        const downloadLink = document.createElement('a');
                        downloadLink.href = data.merged_file_url;
                        downloadLink.download = 'merged_output.pdf';
                        downloadLink.click();
                        alert('PDFs merged successfully!');
                    } else if (data.error) {
                        alert(data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error merging PDFs');
                });
        });
    </script>
</body>

</html>